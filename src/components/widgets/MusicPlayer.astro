---
interface MusicItem {
    url: string;
    cover: string;
    title: string;
    artist: string;
    duration?: string;
}

interface Props {
    src?: string;
    cover?: string;
    title?: string;
    artist?: string;
    list?: MusicItem[];
}

const { src, cover, title, artist, list } = Astro.props;
const currentSrc = src || (list && list[0] ? list[0].url : "");
const currentCover = cover || (list && list[0] ? list[0].cover : "");
const currentTitle = title || (list && list[0] ? list[0].title : "");
const currentArtist = artist || (list && list[0] ? list[0].artist : "");
const lrcUrl = currentSrc ? currentSrc.replace(/\.[^/.]+$/, ".lrc") : "";
const playlistData = list ? JSON.stringify(list) : "[]";
---

<div class="music-player-widget animate-in fade-in slide-in-from-bottom-4 duration-500" data-src={currentSrc} data-lrc={lrcUrl} data-title={currentTitle} data-artist={currentArtist} data-cover={currentCover} data-playlist={playlistData}>
  <div class="bg-neu-base shadow-neu-out rounded-[40px] p-6 md:p-8 relative overflow-hidden">
    <div class="flex flex-col lg:flex-row gap-8 lg:gap-12 min-h-[560px]">
      <div class="lg:w-5/12 flex flex-col items-center justify-center gap-6 py-4">
        <div class="bg-neu-base shadow-neu-in rounded-full w-full aspect-square max-w-[320px] relative flex items-center justify-center bg-[#18181b] shadow-2xl border-6 border-neu-base">
          <!-- Needle -->
          <div id="player-needle" class="absolute top-0 right-4 w-8 h-48 z-20 transition-transform duration-1000 ease-in-out origin-top-center pointer-events-none" style="transform: rotate(0deg); transform-origin: 16px 16px;">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-12 h-12 rounded-full bg-neu-base shadow-neu-out border-4 border-white/20 dark:border-black/20 z-20 flex items-center justify-center">
              <div class="w-4 h-4 rounded-full bg-gray-400 dark:bg-gray-600 shadow-inner"></div>
            </div>
            <div class="absolute top-6 left-1/2 -translate-x-1/2 w-2 h-36 bg-gradient-to-b from-gray-300 to-gray-400 dark:from-gray-600 dark:to-gray-800 rounded-full shadow-md z-10"></div>
            <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-6 h-10 bg-gray-800 dark:bg-black rounded-md shadow-lg flex flex-col items-center">
              <div class="w-full h-1 bg-gray-600 mt-2"></div>
              <div class="w-0.5 h-2 bg-white mt-auto mb-[-2px]"></div>
            </div>
          </div>

          <!-- Record Outer -->
          <div class="relative w-[92%] h-[92%] rounded-full shadow-[inset_0_0_20px_rgba(0,0,0,0.8)] flex items-center justify-center overflow-hidden bg-[#111]">
            <div id="record-outer" class="absolute inset-0 rounded-full bg-[conic-gradient(#1a1a1a_0deg,#2a2a2a_45deg,#111_90deg,#1a1a1a_135deg,#2a2a2a_180deg,#111_225deg,#1a1a1a_270deg,#2a2a2a_315deg,#1a1a1a_360deg)] shadow-inner transition-transform ease-out animate-spin-slow" style="animation-play-state: paused; transition-duration: 1.5s;">
              <div class="absolute inset-0 rounded-full border border-white/5 opacity-30 bg-[repeating-radial-gradient(#000_0,#000_1px,transparent_2px,transparent_4px)]"></div>
            </div>
            <!-- Record Inner (Cover) -->
            <div id="record-inner" class="relative w-[38%] h-[38%] rounded-full overflow-hidden border-[4px] border-[#111] shadow-xl animate-spin-slow" style="animation-play-state: paused;">
              <img id="player-cover" alt="Cover" class="w-full h-full object-cover" src={currentCover || "https://8t2b6pwmhiggowix.public.blob.vercel-storage.com/%E6%88%AA%E5%B1%8F2025-12-24%2010.28.08-ioJSbipqjjLy1o59xus85KpAMYlFdu.png"}>
              <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-[#e5e5e5] rounded-full border border-gray-400 shadow-inner"></div>
            </div>
            <div class="absolute inset-0 rounded-full bg-gradient-to-tr from-white/10 to-transparent pointer-events-none z-10 opacity-60"></div>
          </div>
        </div>
        
        <div class="text-center space-y-2 w-full max-w-[320px]">
          <h2 id="player-title" class="text-xl font-bold text-neu-text tracking-tight truncate">{currentTitle || "Loading..."}</h2>
          <p id="player-artist" class="font-mono text-base font-bold uppercase tracking-widest truncate" style="color: oklch(var(--p)); text-shadow: 0 0 15px oklch(var(--p) / 0.5);">{currentArtist || "Loading..."}</p>
          <div class="flex items-center justify-center gap-3 mt-4 pt-3 border-t border-gray-200/50 dark:border-gray-700/50">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume2 text-gray-400 shrink-0">
              <path d="M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"></path>
              <path d="M16 9a5 5 0 0 1 0 6"></path>
              <path d="M19.364 18.364a9 9 0 0 0 0-12.728"></path>
            </svg>
            <div class="w-24 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full relative overflow-hidden cursor-pointer" id="volume-control">
              <div id="volume-bar" class="absolute top-0 left-0 h-full" style="width: 70%; background-color: oklch(var(--p));"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="lg:w-7/12 flex flex-col gap-5">
        <!-- Main Screen -->
        <div class="flex-1 relative rounded-[24px] overflow-hidden flex flex-col shadow-neu-in border border-neu-border bg-neu-base min-h-[340px] transition-colors duration-300">
          <div class="absolute inset-0 z-0 opacity-20 dark:opacity-40 overflow-hidden">
            <img id="player-bg-cover" class="w-full h-full object-cover blur-[50px] scale-150 transition-all duration-700" alt="" src={cover || "https://music.apple.com/assets/product/1000/images/default-cover-icon-d36802.svg"}>
          </div>
          <div class="absolute inset-0 z-[1] bg-white/40 dark:bg-black/40 pointer-events-none mix-blend-overlay dark:mix-blend-normal"></div>
          
          <!-- Header (Buttons) -->
          <div class="relative z-10 flex justify-between items-center p-4 border-b border-neu-border backdrop-blur-md rounded-t-[24px]">
            <div class="flex gap-1 p-1 bg-black/5 dark:bg-white/10 rounded-xl backdrop-blur-sm">
              <button id="btn-show-playlist" class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1.5 text-neu-text-muted hover:text-neu-btn-text">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-music">
                  <path d="M21 15V6"></path>
                  <path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"></path>
                  <path d="M12 12H3"></path>
                  <path d="M16 6H3"></path>
                  <path d="M12 18H3"></path>
                </svg> 播放列表
              </button>
              <button id="btn-show-lyrics" class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1.5 bg-neu-btn-bg text-neu-btn-text shadow-sm hover:text-neu-btn-text">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic-vocal">
                  <path d="m11 7.601-5.994 8.19a1 1 0 0 0 .1 1.298l.817.818a1 1 0 0 0 1.314.087L15.09 12"></path>
                  <path d="M16.5 21.174C15.5 20.5 14.372 20 13 20c-2.058 0-3.928 2.356-6 2-2.072-.356-2.775-3.369-1.5-4.5"></path>
                  <circle cx="16" cy="7" r="5"></circle>
                </svg> 歌词
              </button>
            </div>
            <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-black/5 dark:bg-black/40 border border-black/5 dark:border-white/10">
              <span id="player-status-dot" class="w-2 h-2 rounded-full bg-red-400"></span>
              <span id="player-status-text" class="text-[10px] font-mono font-bold text-gray-600 dark:text-gray-300 tracking-wider">待机</span>
            </div>
          </div>
          
          <div class="relative z-10 flex-1 overflow-hidden min-h-[280px]">
             <!-- Lyrics Container -->
            <div id="lyrics-container" class="absolute inset-0 overflow-y-auto custom-scrollbar p-6 space-y-6 text-center select-none mask-image-lyrics scroll-smooth">
                <p class="text-neu-text-muted text-sm mt-20">Loading lyrics...</p>
            </div>
             <!-- Playlist Container -->
            <div id="playlist-container" class="absolute inset-0 overflow-y-auto custom-scrollbar p-4 hidden">
                <ul class="space-y-3" id="playlist-list">
                    {list && list.map((item, index) => (
                     <li class="playlist-item group flex items-center gap-3 p-3 rounded-2xl hover:bg-black/5 dark:hover:bg-white/5 border border-transparent transition-all cursor-pointer" data-index={index}>
                        <span class="font-mono text-neu-text-muted text-sm font-bold w-6 text-center group-hover:text-neu-accent transition-colors">{(index + 1).toString().padStart(2, '0')}</span>
                        <!-- Cover -->
                        <div class="relative w-12 h-12 rounded-lg overflow-hidden shrink-0 border border-neu-border/50">
                            <img src={item.cover || "https://music.apple.com/assets/product/1000/images/default-cover-icon-d36802.svg"} class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" alt="cover"/>
                            <div class="absolute inset-0 bg-black/10 flex items-center justify-center opacity-0 group-[.active]:opacity-100 transition-opacity">
                                 <div class="w-1.5 h-4 gap-0.5 flex items-end justify-center">
                                    <div class="w-0.5 bg-white h-2 animate-pulse"></div>
                                    <div class="w-0.5 bg-white h-3 animate-pulse delay-75"></div>
                                    <div class="w-0.5 bg-white h-1 animate-pulse delay-150"></div>
                                 </div>
                            </div>
                        </div>
                        <!-- Info -->
                        <div class="flex-1 min-w-0 flex flex-col justify-center gap-1">
                            <h3 class="font-bold text-neu-text truncate text-sm leading-none group-[.active]:text-neu-accent transition-colors">{item.title || "Unknown Title"}</h3>
                            <p class="text-[11px] text-neu-text-muted truncate uppercase tracking-wider">{item.artist || "Unknown Artist"}</p>
                        </div>
                        <!-- Duration -->
                        <div class="text-xs font-mono text-neu-text-muted font-bold playlist-duration">{item.duration || "--:--"}</div>
                     </li>
                    ))}
                </ul>
            </div>
          </div>
        </div>
        
        <div class="bg-neu-base shadow-neu-in rounded-2xl p-4 md:px-6 flex flex-col gap-4">
          <!-- Progress -->
          <div class="flex items-center gap-3 text-xs font-mono font-bold text-gray-500">
            <span id="current-time" class="w-10 text-right">0:00</span>
            <div class="flex-1 h-2.5 bg-neu-btn-bg rounded-full relative overflow-hidden border border-neu-border cursor-pointer shadow-inner" id="progress-container">
              <div id="progress-bar" class="absolute top-0 left-0 h-full transition-all duration-100 ease-linear" style="width: 0%; background-color: oklch(var(--p));"></div>
            </div>
            <span id="total-time" class="w-10">0:00</span>
          </div>
          <!-- Controls -->
          <div class="flex items-center justify-between px-2">
            <button id="shuffle-btn" class="w-10 h-10 rounded-full flex items-center justify-center transition-all text-neu-text-muted hover:text-neu-text">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shuffle">
                <path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l6.1-8.6c.7-1.1 2-1.7 3.3-1.7H22"></path>
                <path d="m18 2 4 4-4 4"></path>
                <path d="M2 6h1.9c1.5 0 2.9.9 3.6 2.2"></path>
                <path d="M22 18h-5.9c-1.3 0-2.6-.7-3.3-1.8l-.5-.8"></path>
                <path d="m18 14 4 4-4 4"></path>
              </svg>
            </button>
            <div class="flex items-center gap-4">
              <button id="prev-btn" class="bg-neu-base shadow-neu-out rounded-full w-12 h-12 flex items-center justify-center cursor-pointer active:scale-95 transition-transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-skip-back fill-current text-neu-text">
                  <polygon points="19 20 9 12 19 4 19 20"></polygon>
                  <line x1="5" x2="5" y1="19" y2="5"></line>
                </svg>
              </button>
              
              <!-- Play/Pause Button -->
              <button id="play-btn" class="bg-neu-base shadow-neu-out rounded-full w-16 h-16 flex items-center justify-center cursor-pointer transition-all active:scale-95 border-2 border-neu-base text-neu-text shadow-neu-out hover:scale-105">
                <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play fill-current ml-0.5">
                  <polygon points="6 3 20 12 6 21 6 3"></polygon>
                </svg>
                <svg id="icon-pause" class="hidden" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause fill-current">
                  <rect x="6" y="4" width="4" height="16"></rect>
                  <rect x="14" y="4" width="4" height="16"></rect>
                </svg>
              </button>
              
              <button id="next-btn" class="bg-neu-base shadow-neu-out rounded-full w-12 h-12 flex items-center justify-center cursor-pointer active:scale-95 transition-transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-skip-forward fill-current text-neu-text">
                  <polygon points="5 4 15 12 5 20 5 4"></polygon>
                  <line x1="19" x2="19" y1="5" y2="19"></line>
                </svg>
              </button>
            </div>
            <button id="repeat-btn" class="w-10 h-10 rounded-full flex items-center justify-center transition-all text-neu-text-muted hover:text-neu-text">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-repeat">
                <path d="m17 2 4 4-4 4"></path>
                <path d="M3 11v-1a4 4 0 0 1 4-4h14"></path>
                <path d="m7 22-4-4 4-4"></path>
                <path d="M21 13v1a4 4 0 0 1-4 4H3"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style is:global>
    @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .animate-spin-slow { animation: spin-slow 8s linear infinite; }
    .custom-scrollbar::-webkit-scrollbar { width: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .mask-image-lyrics {
        mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
        -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
    }
    .lyric-line {
        transform-origin: center center;
    }
    .lyric-active {
        color: oklch(var(--p)) !important;
        transform: scale(1.05);
        opacity: 1 !important;
        text-shadow: 0 0 20px oklch(var(--p) / 0.6);
    }
  </style>
</div>